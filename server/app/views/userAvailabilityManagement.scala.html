@import play.api.data.Form
@import controllers.{UserAvailabilityForm, UserTimezoneForm}
@import models.{AvailabilityStatus, UserAvailability, UserTimezone, User}
@import java.time.ZoneId
@import scala.jdk.CollectionConverters._

@(user: User, 
  timezoneOpt: Option[UserTimezone], 
  availabilities: List[UserAvailability],
  timezoneForm: Form[UserTimezoneForm],
  availabilityForm: Form[UserAvailabilityForm]
)(implicit request: RequestHeader, flash: Flash, messages: Messages)

@main("Manage Availability", Some(user)) {
        <h1>Manage Your Availability</h1>

        @if(flash.get("success").isDefined) {
            <div role="alert" class="success">
                @flash.get("success")
            </div>
        }

        @if(flash.get("error").isDefined) {
            <div role="alert" class="error">
                @flash.get("error")
            </div>
        }

        <section>
            <h2>Tu zona horaria</h2>
            @timezoneOpt.map { timezone =>
                <div >
                    <p><strong>Actual: </strong> @timezone.timezone</p>
                </div>
            }

            @helper.form(action = routes.UserAvailabilityController.updateTimezone()) {
                @helper.CSRF.formField
		@defining(ZoneId.getAvailableZoneIds.asScala.toSeq.filter(r => r.startsWith("America") || r.startsWith("US") || r.startsWith("Europe")).sorted) { timezones =>
                
			<fieldset role="group">
				<input type="text" id="timezone-search" placeholder="Buscar ciudad o zona horaria..." autocomplete="off"/>
				<select id="timezone"
					name="timezone"
					required
					@if(timezoneForm("timezone").hasErrors) {aria-invalid="true"}>

				    <option value="" disabled
					@if(timezoneForm("timezone").value.isEmpty) {selected}>
					Selecciona una zona horaria
				    </option>

				    @for(tz <- timezones) {
					<option value="@tz"
					@if(
					timezoneForm("timezone").value.contains(tz) ||
					timezoneOpt.exists(_.timezone == tz)
					) {selected}>
				        @tz
				    </option>
				    }
				</select>
				<input type="submit" value="Actualizar"/>
			</fieldset>
			<small> Ejemplo: Lima, La_Paz, Madrid, New_York </small>
		}
            }
        </section>

        <section>
            <h2>Disponibilidad Semanal</h2>
            
            @if(availabilities.nonEmpty) {
                <div class="availability-list">
                    <table>
                        <thead>
                            <tr>
                                <th>Días</th>
                                <th>Horas</th>
                                <th>Disponibilidad</th>
                                <th>¿Eliminar?</th>
                            </tr>
                        </thead>
                        <tbody>
                        @availabilities.map { availability =>
                            <tr>
                                <td>@dayName(availability.fromWeekDay)@if(availability.fromWeekDay != availability.toWeekDay){ - @dayName(availability.toWeekDay)}</td>
                                <td>@availability.fromHourInclusive:00 - @availability.toHourExclusive:59</td>
                                <td>
                                    <span class="status-badge @statusClass(availability.availabilityStatus)">
                                        @statusName(availability.availabilityStatus)
                                    </span>
                                </td>
                                <td>
                                    @helper.form(action = routes.UserAvailabilityController.deleteAvailability(availability.id), Symbol("class") -> "inline-form") {
                                        @helper.CSRF.formField
                                        <button type="submit" class="secondary" onclick="return confirm('Are you sure you want to delete this availability?')">Eliminar</button>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            } else {
                            }

	<article>
	<header> Añade tu disponibilidad </header>

	@helper.form(action = routes.UserAvailabilityController.addAvailability()) {
	    @helper.CSRF.formField
	    
	    <fieldset role="group">
		<label for="fromWeekDay">
		    De (día)
		    <select name="fromWeekDay" id="fromWeekDay" required>
			<option value="1">Lunes</option>
			<option value="2">Martes</option>
			<option value="3">Miércoles</option>
			<option value="4">Jueves</option>
			<option value="5">Viernes</option>
			<option value="6">Sábado</option>
			<option value="7">Domingo</option>
		    </select>
		</label>

		<label for="toWeekDay">
		    a (día)
		    <select name="toWeekDay" id="toWeekDay" required>
			<option value="1">Lunes</option>
			<option value="2">Martes</option>
			<option value="3">Miércoles</option>
			<option value="4">Jueves</option>
			<option value="5">Viernes</option>
			<option value="6">Sábado</option>
			<option value="7">Domingo</option>
		    </select>
		</label>
	</fieldset>
	<fieldset role="group">
		<label for="fromHourInclusive">
		    desde (hora)
		    <select name="fromHourInclusive" id="fromHourInclusive" required>
			@for(hour <- 0 to 23) {
			    <option value="@hour">@{String.format("%02d", hour)}:00</option>
			}
		    </select>
		</label>

		<label for="toHourExclusive">
		    hasta (hora)
		    <select name="toHourExclusive" id="toHourExclusive" required>
			@for(hour <- 0 to 23) {
			    <option value="@hour">@{String.format("%02d", hour)}:59</option>
			}
		    </select>
		</label>
		</fieldset>
		<fieldset role="group">

		    <select name="availabilityStatus" id="availabilityStatus" required>
			<option value="HIGHLY_AVAILABLE">MUY disponible</option>
			<option value="MAYBE_AVAILABLE">probablemente disponible</option>
		    </select>
				<input type="submit" value="Enviar"/>


	    </fieldset>


	}
	<div id="message_parse"></div>

	<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Timezone search functionality
		const timezoneSearch = document.getElementById('timezone-search');
		const timezoneSelect = document.getElementById('timezone');
		
		if (timezoneSearch && timezoneSelect) {
			// Cache original options with their properties
			const originalOptions = Array.from(timezoneSelect.options).map(option => ({
				value: option.value,
				text: option.text,
				disabled: option.disabled,
				selected: option.selected,
				element: option.cloneNode(true)
			}));
			
			timezoneSearch.addEventListener('input', function() {
				const query = this.value.trim();
				
				// Clear and rebuild select
				timezoneSelect.innerHTML = '';
				
				// Always add placeholder option first
				const placeholderOption = originalOptions.find(opt => opt.disabled);
				if (placeholderOption) {
					const placeholderClone = placeholderOption.element.cloneNode(true);
					timezoneSelect.add(placeholderClone);
				}
				
				// If no query, show all options
				if (!query) {
					originalOptions.forEach(opt => {
						if (!opt.disabled) {
							timezoneSelect.add(opt.element.cloneNode(true));
						}
					});
					return;
				}
				
				// Try regex search first, fallback to text search
				let matcher = null;
				let useRegex = false;
				
				try {
					matcher = new RegExp(query, 'i');
					useRegex = true;
				} catch {
					// Invalid regex, will use text search
					useRegex = false;
				}
				
				// Filter options
				const matchedOptions = originalOptions.filter(option => {
					if (option.disabled || !option.value) return false;
					
					if (useRegex && matcher) {
						return matcher.test(option.value);
					} else {
						// Text search: case-insensitive partial match
						const searchText = option.value.toLowerCase();
						const searchTerms = query.toLowerCase().split(/\s+/);
						return searchTerms.every(term => searchText.includes(term));
					}
				});
				
				// Sort matches: prioritize exact matches, then relevance
				matchedOptions.sort((a, b) => {
					const aText = a.value.toLowerCase();
					const bText = b.value.toLowerCase();
					const queryLower = query.toLowerCase();
					
					// Exact matches first
					if (aText === queryLower) return -1;
					if (bText === queryLower) return 1;
					
					// Prioritize city matches (after last /)
					const aCity = aText.split('/').pop();
					const bCity = bText.split('/').pop();
					const aCityMatch = aCity.includes(queryLower);
					const bCityMatch = bCity.includes(queryLower);
					
					if (aCityMatch && !bCityMatch) return -1;
					if (!aCityMatch && bCityMatch) return 1;
					
					// Then alphabetical
					return aText.localeCompare(bText);
				});
				
				// Add matched options
				matchedOptions.forEach(option => {
					timezoneSelect.add(option.element.cloneNode(true));
				});
				
				// Show no results message if needed
				if (matchedOptions.length === 0) {
					const noResultOption = document.createElement('option');
					noResultOption.value = '';
					noResultOption.disabled = true;
					noResultOption.textContent = 'No se encontraron resultados';
					timezoneSelect.add(noResultOption);
				}
			});
		}
		
		// Availability form functionality
		const form = document.querySelector('form[action="@routes.UserAvailabilityController.addAvailability()"]');
		const messageDiv = document.getElementById('message_parse');
		const fromWeekDay = document.getElementById('fromWeekDay');
		const toWeekDay = document.getElementById('toWeekDay');
		const fromHour = document.getElementById('fromHourInclusive');
		const toHour = document.getElementById('toHourExclusive');
		const availabilityStatus = document.getElementById('availabilityStatus');

		function getDayName(dayNum) {
			const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
			return days[dayNum - 1];
		}

		function formatHourFrom(hour) {
			return String(hour).padStart(2, '0') + ':00';
		}
		function formatHourTo(hour) {
			return String(hour).padStart(2, '0') + ':59';
		}

		function validateAndShowMessage() {
			const fromDay = parseInt(fromWeekDay.value);
			const toDay = parseInt(toWeekDay.value);
			const fromHourVal = parseInt(fromHour.value);
			const toHourVal = parseInt(toHour.value);
			const status = availabilityStatus.options[availabilityStatus.selectedIndex].text;

			messageDiv.innerHTML = '';
			messageDiv.className = '';

			if (toDay < fromDay) {
				messageDiv.innerHTML = '❌ El día "hasta" debe ser igual o posterior al día "desde"';
				messageDiv.className = 'error-message';
				return false;
			}

			if (toHourVal < fromHourVal) {
				messageDiv.innerHTML = '❌La hora "hasta" debe ser posterior que la hora "desde"';
				messageDiv.className = 'error-message';
				return false;
			}

			let dayText = '';
			if (fromDay === toDay) {
				dayText = 'El ' + getDayName(fromDay);
			} else {
				dayText = 'De ' + getDayName(fromDay) + ' a ' + getDayName(toDay);
			}

			const message = '✅ ' + dayText + ' desde las ' + formatHourFrom(fromHourVal) + ' hasta las ' + formatHourTo(toHourVal) + ' estoy ' + status;
			messageDiv.innerHTML = message;
			messageDiv.className = 'success-message';
			return true;
		}

		[fromWeekDay, toWeekDay, fromHour, toHour, availabilityStatus].forEach(element => {
			element.addEventListener('change', validateAndShowMessage);
		});

		// Prevent form submission if validation fails
		form.addEventListener('submit', function(e) {
			if (!validateAndShowMessage()) {
				e.preventDefault();
			}
		});

		// Initial validation
		validateAndShowMessage();
	});
	</script>

	
	<footer>
		    <p>Ejemplo: De <strong> Lunes </strong> a <strong> Viernes  </strong> desde las <strong> 18:00 </strong> hasta las <strong> 21:59 </strong> estoy <strong> MUY disponible </strong> </p>
		    <p>Ejemplo: El <strong> Sábado </strong> </strong> desde las <strong> 18:00 </strong> hasta las <strong> 23:59 </strong> estoy <strong> probablemente disponible </strong> </p>

	</footer>
	</article>
        </section>

}

@dayName(dayNum: Int) = @{
    dayNum match {
        case 1 => "Lunes"
        case 2 => "Martes"
        case 3 => "Miércoles"
        case 4 => "Jueves"
        case 5 => "Viernes"
        case 6 => "Sábado"
        case 7 => "Domingo"
    }
}

@statusClass(status: AvailabilityStatus) = @{
    status match {
        case AvailabilityStatus.HighlyAvailable => "status-highly"
        case AvailabilityStatus.MaybeAvailable => "status-maybe"
    }
}

@statusName(status: AvailabilityStatus) = @{
    status match {
        case AvailabilityStatus.HighlyAvailable => "MUY disponible"
        case AvailabilityStatus.MaybeAvailable => "probablemente disponible"
    }
}
