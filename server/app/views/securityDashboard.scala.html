@(user: models.User, stats: Seq[(String, services.IpStats)], blacklist: Set[String])(implicit request: RequestHeader, flash: Flash, messages: Messages)

@main("Security Dashboard", Some(user)) {
    <div class="container mt-4">
        <h1>Security Dashboard</h1>

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Blacklisted IPs</h5>
                        <p class="display-4">@blacklist.size</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Tracked IPs</h5>
                        <p class="display-4">@stats.size</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Suspicious IPs</h5>
                        <p class="display-4">@stats.count(_._2.suspiciousPathCount > 0)</p>
                    </div>
                </div>
            </div>
        </div>

        <h2>Blacklisted IPs</h2>
        @if(blacklist.isEmpty) {
            <p class="text-muted">No IPs currently blacklisted</p>
        } else {
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                @for(ip <- blacklist) {
                    <tr>
                        <td><code>@ip</code></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="unblockIp('@ip')">Unblock</button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }

        <h2 class="mt-4">IP Statistics (Top 50 by suspicious activity)</h2>
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Requests</th>
                    <th>404s</th>
                    <th>403s</th>
                    <th>Suspicious Paths</th>
                    <th>First Seen</th>
                    <th>Last Seen</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            @for((ip, stat) <- stats) {
                <tr class="@if(stat.suspiciousPathCount >= 2){table-warning}@if(blacklist.contains(ip)){table-danger}">
                    <td><code>@ip</code></td>
                    <td>@stat.requestCount</td>
                    <td>@stat.notFoundCount</td>
                    <td>@stat.forbiddenCount</td>
                    <td>@stat.suspiciousPathCount</td>
                    <td>@stat.firstSeen</td>
                    <td>@stat.lastSeen</td>
                    <td>
                        @if(!blacklist.contains(ip)) {
                            <button class="btn btn-sm btn-danger" onclick="blockIp('@ip')">Block</button>
                        } else {
                            <span class="badge bg-danger">Blocked</span>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <script>
        function blockIp(ip) {
            if (confirm('Block IP ' + ip + '?')) {
                fetch('/admin/security/block/' + encodeURIComponent(ip), { method: 'POST' })
                    .then(() => location.reload());
            }
        }

        function unblockIp(ip) {
            if (confirm('Unblock IP ' + ip + '?')) {
                fetch('/admin/security/unblock/' + encodeURIComponent(ip), { method: 'POST' })
                    .then(() => location.reload());
            }
        }
    </script>
}
