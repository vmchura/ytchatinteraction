@import play.api.mvc.ControllerHelpers.request2flash
@import models.{Tournament, TournamentRegistration, TournamentStatus, User}

@(tournamentsData: List[(Tournament, List[(TournamentRegistration, User)])])(implicit request: RequestHeader, messages: Messages, webJarsUtil: org.webjars.play.WebJarsUtil)

@main("Tournaments") {
    <div class="container">
        <header>
            <h1>Tournaments</h1>
            <p>View all tournaments currently open for registration and tournaments in progress.</p>
        </header>

        @if(request.flash.get("success").isDefined) {
            <div role="alert">
                @request.flash.get("success")
            </div>
        }

        @if(request.flash.get("error").isDefined) {
            <div role="alert">
                @request.flash.get("error")
            </div>
        }

        @if(tournamentsData.isEmpty) {
            <article>
                <header>
                    <h3>No Active Tournaments</h3>
                </header>
                <p>There are currently no tournaments open for registration or in progress.</p>
                <footer>
                    <a href="@routes.TournamentController.showCreateForm()" role="button">Create New Tournament</a>
                    <a href="@routes.HomeController.index()" role="button" class="secondary">Back to Home</a>
                </footer>
            </article>
        } else {
            @defining(tournamentsData.filter(_._1.status == TournamentStatus.RegistrationOpen)) { openTournaments =>
                @defining(tournamentsData.filter(_._1.status == TournamentStatus.RegistrationClosed)) { closedRegistrationTournaments =>
                    @defining(tournamentsData.filter(_._1.status == TournamentStatus.InProgress)) { inProgressTournaments =>
                        @defining(tournamentsData.filter(_._1.status == TournamentStatus.Completed)) { completedTournaments =>
                            @defining(tournamentsData.filter(_._1.status == TournamentStatus.Cancelled)) { cancelledTournaments =>

            @if(openTournaments.nonEmpty) {
                <section>
                    <h2>Open for Registration</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- openTournaments) {
                            <article>
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>

                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Max Participants:</strong> @tournament.maxParticipants</li>
                                        <li><strong>Current Registrations:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark>Registration Open</mark></li>
                                        <li><strong>Registration Ends:</strong> @tournament.registrationEndAt.toString.take(19).replace("T", " ")</li>
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                    </ul>
                                </section>

                                @if(registrations.nonEmpty) {
                                    <section>
                                        <h4>Registered Users (@registrations.length)</h4>
                                        <ul>
                                            @for((registration, user) <- registrations) {
                                                <li>
                                                    <strong>@user.userName</strong>
                                                    <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                                </li>
                                            }
                                        </ul>
                                    </section>
                                } else {
                                    <section>
                                        <p><em>No users registered yet.</em></p>
                                    </section>
                                }

                                <footer>
                                    <div class="grid">
                                        <form method="post" action="@routes.TournamentController.startTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            
                                            <!-- Tournament Configuration -->
                                            <div class="grid" style="margin-bottom: 1rem;">
                                                <div>
                                                    <label for="tournamentType">Tournament Type</label>
                                                    <select id="tournamentType" name="tournamentType">
                                                        <option value="single elimination">Single Elimination</option>
                                                        <option value="double elimination">Double Elimination</option>
                                                        <option value="round robin">Round Robin</option>
                                                        <option value="swiss">Swiss</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label for="groupSize">Group Size</label>
                                                    <input type="number" id="groupSize" name="groupSize" value="5" min="2" max="16">
                                                </div>
                                            </div>
                                            
                                            <div class="grid" style="margin-bottom: 1rem;">
                                                <div>
                                                    <label for="groupStageEnabled">Enable Group Stage</label>
                                                    <input type="checkbox" id="groupStageEnabled" name="groupStageEnabled" checked>
                                                </div>
                                                <div>
                                                    <label for="groupStageType">Group Stage Type</label>
                                                    <select id="groupStageType" name="groupStageType">
                                                        <option value="round robin">Round Robin</option>
                                                        <option value="single elimination">Single Elimination</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="grid" style="margin-bottom: 1rem;">
                                                <div>
                                                    <label for="participantCountToAdvancePerGroup">Advancing per Group</label>
                                                    <input type="number" id="participantCountToAdvancePerGroup" name="participantCountToAdvancePerGroup" value="1" min="1" max="8">
                                                </div>
                                                <div>
                                                    <label for="holdThirdPlaceMatch">3rd Place Match</label>
                                                    <input type="checkbox" id="holdThirdPlaceMatch" name="holdThirdPlaceMatch">
                                                </div>
                                            </div>
                                            
                                            <div style="margin-bottom: 1rem;">
                                                <label for="sequentialPairings">Sequential Pairings</label>
                                                <input type="checkbox" id="sequentialPairings" name="sequentialPairings" checked>
                                            </div>
                                            
                                            <button type="submit"
                                                    onclick="return confirm('Are you sure you want to start this tournament? This will close registration and begin the tournament. If needed, fake participants will be added to complete a round robin.');">
                                                Start Tournament
                                                @if(registrations.length == 0) {
                                                    (will add fake participants)
                                                } else if(registrations.length == 1) {
                                                    (will add fake participants)
                                                }
                                            </button>
                                        </form>
                                        <form method="post" action="@routes.TournamentController.completeTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="secondary"
                                                    onclick="return confirm('Are you sure you want to mark this tournament as completed?');">
                                                Complete
                                            </button>
                                        </form>
                                        <form method="post" action="@routes.TournamentController.cancelTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="contrast outline"
                                                    onclick="return confirm('Are you sure you want to cancel this tournament?');">
                                                Cancel
                                            </button>
                                        </form>
                                    </div>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            @if(closedRegistrationTournaments.nonEmpty) {
                <section>
                    <h2>Registration Closed</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- closedRegistrationTournaments) {
                            <article style="border-left: 4px solid var(--pico-orange-400);">
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>

                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Participants:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark style="background-color: var(--pico-orange-400);">Registration Closed</mark></li>
                                        <li><strong>Registration Ended:</strong> @tournament.registrationEndAt.toString.take(19).replace("T", " ")</li>
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                    </ul>
                                </section>

                                <section>
                                    <h4>Participants (@registrations.length)</h4>
                                    <ul>
                                        @for((registration, user) <- registrations) {
                                            <li>
                                                <strong>@user.userName</strong>
                                                <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                            </li>
                                        }
                                    </ul>
                                </section>

                                <footer>
                                    <div class="grid">
                                        <form method="post" action="@routes.TournamentController.startTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit"
                                                    onclick="return confirm('Are you sure you want to start this tournament?');">
                                                Start Tournament
                                            </button>
                                        </form>
                                        <form method="post" action="@routes.TournamentController.completeTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="secondary"
                                                    onclick="return confirm('Are you sure you want to mark this tournament as completed?');">
                                                Complete
                                            </button>
                                        </form>
                                        <form method="post" action="@routes.TournamentController.cancelTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="contrast outline"
                                                    onclick="return confirm('Are you sure you want to cancel this tournament?');">
                                                Cancel
                                            </button>
                                        </form>
                                    </div>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            @if(inProgressTournaments.nonEmpty) {
                <section>
                    <h2>In Progress</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- inProgressTournaments) {
                            <article style="border-left: 4px solid var(--pico-primary);">
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>

                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Participants:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark>In Progress</mark></li>
                                        @if(tournament.tournamentStartAt.isDefined) {
                                            <li><strong>Started:</strong> @tournament.tournamentStartAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                        @if(tournament.challongeUrl.isDefined) {
                                            <li><strong>Challonge URL:</strong> <a href="@tournament.challongeUrl.get" target="_blank">View on Challonge</a></li>
                                        }
                                    </ul>
                                </section>

                                <section>
                                    <h4>Participants (@registrations.length)</h4>
                                    <ul>
                                        @for((registration, user) <- registrations) {
                                            <li>
                                                <strong>@user.userName</strong>
                                                <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                            </li>
                                        }
                                    </ul>
                                </section>

                                <footer>
                                    <div class="grid">
                                        <form method="post" action="@routes.TournamentController.completeTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="secondary"
                                                    onclick="return confirm('Are you sure you want to mark this tournament as completed?');">
                                                Complete
                                            </button>
                                        </form>
                                        <form method="post" action="@routes.TournamentController.cancelTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" class="contrast outline"
                                                    onclick="return confirm('Are you sure you want to cancel this tournament?');">
                                                Cancel
                                            </button>
                                        </form>
                                    </div>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            @if(completedTournaments.nonEmpty) {
                <section>
                    <h2>Completed Tournaments</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- completedTournaments) {
                            <article style="border-left: 4px solid var(--pico-green-400);">
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>

                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Participants:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark style="background-color: var(--pico-green-400);">Completed</mark></li>
                                        @if(tournament.tournamentStartAt.isDefined) {
                                            <li><strong>Started:</strong> @tournament.tournamentStartAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        @if(tournament.tournamentEndAt.isDefined) {
                                            <li><strong>Ended:</strong> @tournament.tournamentEndAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                        @if(tournament.challongeUrl.isDefined) {
                                            <li><strong>Challonge URL:</strong> <a href="@tournament.challongeUrl.get" target="_blank">View Results</a></li>
                                        }
                                    </ul>
                                </section>

                                <section>
                                    <h4>Final Participants (@registrations.length)</h4>
                                    <ul>
                                        @for((registration, user) <- registrations) {
                                            <li>
                                                <strong>@user.userName</strong>
                                                <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                            </li>
                                        }
                                    </ul>
                                </section>

                                <footer>
                                    <p><em>This tournament has been completed.</em></p>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            @if(cancelledTournaments.nonEmpty) {
                <section>
                    <h2>Cancelled Tournaments</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- cancelledTournaments) {
                            <article style="border-left: 4px solid var(--pico-red-400);">
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>

                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Participants:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark style="background-color: var(--pico-red-400);">Cancelled</mark></li>
                                        @if(tournament.tournamentStartAt.isDefined) {
                                            <li><strong>Started:</strong> @tournament.tournamentStartAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        @if(tournament.tournamentEndAt.isDefined) {
                                            <li><strong>Cancelled:</strong> @tournament.tournamentEndAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                    </ul>
                                </section>

                                <section>
                                    <h4>Registered Participants (@registrations.length)</h4>
                                    <ul>
                                        @for((registration, user) <- registrations) {
                                            <li>
                                                <strong>@user.userName</strong>
                                                <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                            </li>
                                        }
                                    </ul>
                                </section>

                                <footer>
                                    <p><em>This tournament has been cancelled.</em></p>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            <footer style="margin-top: 2rem;">
                <a href="@routes.TournamentController.showCreateForm()" role="button">Create New Tournament</a>
                <a href="@routes.HomeController.index()" role="button" class="secondary">Back to Home</a>
            </footer>
                            }
                        }
                    }
                }
            }
        }
    </div>

    <script>
        // Auto-dismiss flash messages after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('[role="alert"]');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            });
        }, 5000);
    </script>
}
