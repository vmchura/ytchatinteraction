@import models.Tournament
@import controllers.routes
@import java.time.format.DateTimeFormatter
@import java.time.ZoneId
@import models.viewmodels.*
@import models.viewmodels.TournamentRegistrationUserStatus.*
@(tournamentViewDataForUser: TournamentOpenDataUser)(implicit request: RequestHeader, messages: Messages)

<article id="tournament-@tournamentViewDataForUser.id">
    <header>
        <h3>@tournamentViewDataForUser.name</h3>
    </header>

    @tournamentViewDataForUser.userRegistered match {
        case Registered => {
            <button disabled>@messages("partials.tournament.already.registered")</button>
        }
        case Unregistered => {
            <form action="@routes.UserEventsController.registerForTournament(tournamentViewDataForUser.id)" method="POST" id="registration-form-@tournamentViewDataForUser.id">
                @helper.CSRF.formField
                <fieldset class="grid" style="grid-template-columns: 1fr;">
                    <label>
                        Código de registro
                        <input
                            name="tournamentcode"
                            aria-label="Code"
                            required
                        />
                    </label>

                    <label>
                        Selecciona tu raza
                        <select name="race" id="race-select-@tournamentViewDataForUser.id" required>
                            <option value="Protoss">Protoss</option>
                            <option value="Zerg">Zerg</option>
                            <option value="Terran">Terran</option>
                        </select>
                    </label>
		</fieldset>
			<fieldset> 

                    <label>
                        <input
                            type="checkbox"
                            name="acceptedRules"
                            id="rules-checkbox-@tournamentViewDataForUser.id"
                            value="true"
                            required
                        />
                        He leído y acepto las <a href="@routes.UserEventsController.tournamentRules()" target="_blank">bases y condiciones del torneo</a>
                    </label>

                    <input
                        type="submit"
                        id="submit-btn-@tournamentViewDataForUser.id"
                        value=@messages("partials.tournament.register")
                    />
                </fieldset>
            </form>
@tournamentViewDataForUser.registrationRequirements.map { req =>
                        <div class="registration-requirements" id="req-container-@tournamentViewDataForUser.id" style="margin: 1rem 0; padding: 1rem; background: var(--card-background-color); border-radius: var(--border-radius);">
                            <h4>Requisitos de registro:</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li id="replays-status-@tournamentViewDataForUser.id">
                                    <span id="replays-icon-@tournamentViewDataForUser.id"></span>
                                    Replays base: 2 por matchup (6 total)
                                    <small><a href="@routes.AnalyticalUploadController.uploadAnalyticalFile()">Subir replays</a></small>
                                    <div id="replays-details-@tournamentViewDataForUser.id" style="margin-left: 1.5rem; font-size: 0.9em;">
                                        <div class="race-req" data-race="Protoss" style="display: none;">
                                            <span class="vs-protoss-icon"></span> vs Protoss: <span class="vs-protoss-count">0</span>/2<br>
                                            <span class="vs-zerg-icon"></span> vs Zerg: <span class="vs-zerg-count">0</span>/2<br>
                                            <span class="vs-terran-icon"></span> vs Terran: <span class="vs-terran-count">0</span>/2
                                        </div>
                                        <div class="race-req" data-race="Zerg" style="display: none;">
                                            <span class="vs-protoss-icon"></span> vs Protoss: <span class="vs-protoss-count">0</span>/2<br>
                                            <span class="vs-zerg-icon"></span> vs Zerg: <span class="vs-zerg-count">0</span>/2<br>
                                            <span class="vs-terran-icon"></span> vs Terran: <span class="vs-terran-count">0</span>/2
                                        </div>
                                        <div class="race-req" data-race="Terran" style="display: none;">
                                            <span class="vs-protoss-icon"></span> vs Protoss: <span class="vs-protoss-count">0</span>/2<br>
                                            <span class="vs-zerg-icon"></span> vs Zerg: <span class="vs-zerg-count">0</span>/2<br>
                                            <span class="vs-terran-icon"></span> vs Terran: <span class="vs-terran-count">0</span>/2
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    @if(req.hasTimezone) {
                                        <span style="color: green;">✓</span>
                                    } else {
                                        <span style="color: red;">✗</span>
                                    }
                                    Zona horaria registrada
                                    @if(!req.hasTimezone) {
                                        <small><a href="@routes.UserAvailabilityController.showAvailabilityManagement()">Configurar zona horaria</a></small>
                                    }
                                </li>
                                <li>
                                    @if(req.hasAvailability) {
                                        <span style="color: green;">✓</span>
                                    } else {
                                        <span style="color: red;">✗</span>
                                    }
                                    Horario de disponibilidad registrado
                                    @if(!req.hasAvailability) {
                                        <small><a href="@routes.UserAvailabilityController.showAvailabilityManagement()">Configurar disponibilidad</a></small>
                                    }
                                </li>
                            </ul>
                        </div>
                        <script>
                            window.raceRequirements = window.raceRequirements || {};
                            window.raceRequirements[@tournamentViewDataForUser.id] = {
                                hasAvailability: @req.hasAvailability,
                                hasTimezone: @req.hasTimezone,
                                requirementsPerRace: {
                                    @req.requirementsPerRace.map { case (race, raceReq) =>
                                        '@race': {
                                            hasEnoughReplays: @raceReq.hasEnoughReplays,
                                            replayCounts: {
                                                vsProtoss: @raceReq.replayCounts.vsProtoss,
                                                vsZerg: @raceReq.replayCounts.vsZerg,
                                                vsTerran: @raceReq.replayCounts.vsTerran
                                            }
                                        },
                                    }
                                }
                            };
                        </script>
                    }
            <script>
                (function() {
                    const form = document.getElementById('registration-form-@tournamentViewDataForUser.id');
                    const raceSelect = document.getElementById('race-select-@tournamentViewDataForUser.id');
                    const rulesCheckbox = document.getElementById('rules-checkbox-@tournamentViewDataForUser.id');
                    const submitBtn = document.getElementById('submit-btn-@tournamentViewDataForUser.id');
                    const tournamentId = @tournamentViewDataForUser.id;
                    const reqData = window.raceRequirements && window.raceRequirements[tournamentId];

                    function updateRequirementsDisplay() {
                        if (!reqData) return;
                        
                        const selectedRace = raceSelect.value;
                        const raceReq = reqData.requirementsPerRace[selectedRace];
                        
                        // Hide all race requirement details
                        document.querySelectorAll('#req-container-' + tournamentId + ' .race-req').forEach(el => {
                            el.style.display = 'none';
                        });
                        
                        if (raceReq) {
                            // Show selected race details
                            const raceDetails = document.querySelector('#req-container-' + tournamentId + ' .race-req[data-race="' + selectedRace + '"]');
                            if (raceDetails) {
                                raceDetails.style.display = 'block';
                                // Update counts
                                raceDetails.querySelector('.vs-protoss-count').textContent = raceReq.replayCounts.vsProtoss;
                                raceDetails.querySelector('.vs-zerg-count').textContent = raceReq.replayCounts.vsZerg;
                                raceDetails.querySelector('.vs-terran-count').textContent = raceReq.replayCounts.vsTerran;
                                // Update icons
                                raceDetails.querySelector('.vs-protoss-icon').textContent = raceReq.replayCounts.vsProtoss >= 2 ? '✓' : '✗';
                                raceDetails.querySelector('.vs-protoss-icon').style.color = raceReq.replayCounts.vsProtoss >= 2 ? 'green' : 'red';
                                raceDetails.querySelector('.vs-zerg-icon').textContent = raceReq.replayCounts.vsZerg >= 2 ? '✓' : '✗';
                                raceDetails.querySelector('.vs-zerg-icon').style.color = raceReq.replayCounts.vsZerg >= 2 ? 'green' : 'red';
                                raceDetails.querySelector('.vs-terran-icon').textContent = raceReq.replayCounts.vsTerran >= 2 ? '✓' : '✗';
                                raceDetails.querySelector('.vs-terran-icon').style.color = raceReq.replayCounts.vsTerran >= 2 ? 'green' : 'red';
                            }
                            
                            // Update main replays status
                            const replaysIcon = document.getElementById('replays-icon-' + tournamentId);
                            if (replaysIcon) {
                                replaysIcon.textContent = raceReq.hasEnoughReplays ? '✓' : '✗';
                                replaysIcon.style.color = raceReq.hasEnoughReplays ? 'green' : 'red';
                            }
                        }
                    }

                    function validateForm() {
                        const hasRace = raceSelect.value !== '';
                        const hasAcceptedRules = rulesCheckbox.checked;
                        let hasEnoughReplays = false;
                        let hasAvailability = false;
                        let hasTimezone = false;
                        
                        if (reqData && raceSelect.value) {
                            const raceReq = reqData.requirementsPerRace[raceSelect.value];
                            if (raceReq) {
                                hasEnoughReplays = raceReq.hasEnoughReplays;
                            }
                            hasAvailability = reqData.hasAvailability;
                            hasTimezone = reqData.hasTimezone;
                        }
                        
                        submitBtn.disabled = !(hasRace && hasAcceptedRules && hasEnoughReplays && hasAvailability && hasTimezone);
                    }

                    raceSelect.addEventListener('change', function() {
                        updateRequirementsDisplay();
                        validateForm();
                    });
                    rulesCheckbox.addEventListener('change', validateForm);
                    
                    // Initial display
                    updateRequirementsDisplay();
                    validateForm();
                })();
            </script>
        }
        case NotAbleToRegister => {
            <div class="grid" style="grid-template-columns: 1fr;">
                <button disabled>@messages("partials.tournament.register")</button>
                @tournamentViewDataForUser.contentCreatorInfo.map { contentCreator =>
                    <small>
                        @messages("partials.tournament.subscription.required.channel", contentCreator.youtubeChannelName)
                    </small>
                }
            </div>
            @tournamentViewDataForUser.registrationRequirements.map { req =>
                <div class="registration-missing" style="margin-top: 1rem; padding: 1rem; background: var(--card-background-color); border-radius: var(--border-radius);">
                    <h4>Faltan requisitos:</h4>
                    <ul style="list-style: none; padding: 0;">
                        @if(!req.hasEnoughReplays) {
                            <li style="color: red;">✗ Subir al menos 2 replays base por matchup (6 total)</li>
                            @req.replayCounts.map { counts =>
                                <ul style="margin-left: 1.5rem; font-size: 0.9em;">
                                    @if(counts.vsProtoss < 2) {
                                        <li style="color: orange;">vs Protoss: @counts.vsProtoss/2</li>
                                    }
                                    @if(counts.vsZerg < 2) {
                                        <li style="color: orange;">vs Zerg: @counts.vsZerg/2</li>
                                    }
                                    @if(counts.vsTerran < 2) {
                                        <li style="color: orange;">vs Terran: @counts.vsTerran/2</li>
                                    }
                                </ul>
                            }
                            <li><a href="@routes.AnalyticalUploadController.uploadAnalyticalFile()" role="button" class="secondary">Subir replays</a></li>
                        }
                        @if(!req.hasTimezone) {
                            <li style="color: red;">✗ Configurar tu zona horaria</li>
                            <li><a href="@routes.UserAvailabilityController.showAvailabilityManagement()" role="button" class="secondary">Configurar zona horaria</a></li>
                        }
                        @if(!req.hasAvailability) {
                            <li style="color: red;">✗ Configurar tu horario de disponibilidad</li>
                            <li><a href="@routes.UserAvailabilityController.showAvailabilityManagement()" role="button" class="secondary">Configurar disponibilidad</a></li>
                        }
                    </ul>
                </div>
            }
        }
    }
</article>
