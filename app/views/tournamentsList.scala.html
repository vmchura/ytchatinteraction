@import play.api.mvc.ControllerHelpers.request2flash
@import models.{Tournament, TournamentRegistration, TournamentStatus, User}

@(tournamentsData: List[(Tournament, List[(TournamentRegistration, User)])])(implicit request: RequestHeader, messages: Messages, webJarsUtil: org.webjars.play.WebJarsUtil)

@main("Tournaments") {
    <div class="container">
        <header>
            <h1>Tournaments</h1>
            <p>View all tournaments currently open for registration and tournaments in progress.</p>
        </header>

        @if(request.flash.get("success").isDefined) {
            <div role="alert">
                @request.flash.get("success")
            </div>
        }

        @if(request.flash.get("error").isDefined) {
            <div role="alert">
                @request.flash.get("error")
            </div>
        }

        @if(tournamentsData.isEmpty) {
            <article>
                <header>
                    <h3>No Active Tournaments</h3>
                </header>
                <p>There are currently no tournaments open for registration or in progress.</p>
                <footer>
                    <a href="@routes.TournamentController.showCreateForm()" role="button">Create New Tournament</a>
                    <a href="@routes.HomeController.index()" role="button" class="secondary">Back to Home</a>
                </footer>
            </article>
        } else {
            @defining(tournamentsData.filter(_._1.status == TournamentStatus.RegistrationOpen)) { openTournaments =>
                @defining(tournamentsData.filter(_._1.status == TournamentStatus.InProgress)) { inProgressTournaments =>

            @if(openTournaments.nonEmpty) {
                <section>
                    <h2>Open for Registration</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- openTournaments) {
                            <article>
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>
                                
                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Max Participants:</strong> @tournament.maxParticipants</li>
                                        <li><strong>Current Registrations:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark>Registration Open</mark></li>
                                        <li><strong>Registration Ends:</strong> @tournament.registrationEndAt.toString.take(19).replace("T", " ")</li>
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                    </ul>
                                </section>

                                @if(registrations.nonEmpty) {
                                    <section>
                                        <h4>Registered Users (@registrations.length)</h4>
                                        <ul>
                                            @for((registration, user) <- registrations) {
                                                <li>
                                                    <strong>@user.userName</strong>
                                                    <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                                </li>
                                            }
                                        </ul>
                                    </section>
                                } else {
                                    <section>
                                        <p><em>No users registered yet.</em></p>
                                    </section>
                                }

                                <footer>
                                    @if(registrations.length >= 2) {
                                        <form method="post" action="@routes.TournamentController.startTournament(tournament.id)" style="display: inline;">
                                            @helper.CSRF.formField
                                            <button type="submit" 
                                                    onclick="return confirm('Are you sure you want to start this tournament? This will close registration and begin the tournament.');">
                                                Start Tournament
                                            </button>
                                        </form>
                                    } else {
                                        <button disabled title="At least 2 participants required to start">
                                            Start Tournament (Need @{2 - registrations.length} more)
                                        </button>
                                    }
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            @if(inProgressTournaments.nonEmpty) {
                <section>
                    <h2>In Progress</h2>
                    <div class="grid">
                        @for((tournament, registrations) <- inProgressTournaments) {
                            <article style="border-left: 4px solid var(--pico-primary);">
                                <header>
                                    <h3>@tournament.name</h3>
                                    @if(tournament.description.isDefined) {
                                        <p>@tournament.description.get</p>
                                    }
                                </header>
                                
                                <section>
                                    <h4>Tournament Details</h4>
                                    <ul>
                                        <li><strong>Participants:</strong> @registrations.length</li>
                                        <li><strong>Status:</strong> <mark>In Progress</mark></li>
                                        @if(tournament.tournamentStartAt.isDefined) {
                                            <li><strong>Started:</strong> @tournament.tournamentStartAt.get.toString.take(19).replace("T", " ")</li>
                                        }
                                        <li><strong>Created:</strong> @tournament.createdAt.toString.take(19).replace("T", " ")</li>
                                    </ul>
                                </section>

                                <section>
                                    <h4>Participants (@registrations.length)</h4>
                                    <ul>
                                        @for((registration, user) <- registrations) {
                                            <li>
                                                <strong>@user.userName</strong>
                                                <small> - Registered: @registration.registeredAt.toString.take(19).replace("T", " ")</small>
                                            </li>
                                        }
                                    </ul>
                                </section>

                                <footer>
                                    <button disabled>Tournament Running</button>
                                </footer>
                            </article>
                        }
                    </div>
                </section>
            }

            <footer style="margin-top: 2rem;">
                <a href="@routes.TournamentController.showCreateForm()" role="button">Create New Tournament</a>
                <a href="@routes.HomeController.index()" role="button" class="secondary">Back to Home</a>
            </footer>
                }
            }
        }
    </div>

    <script>
        // Auto-dismiss flash messages after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('[role="alert"]');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            });
        }, 5000);
    </script>
}
