@import models.User
@(user: Option[User])(implicit request: RequestHeader, flash: Flash)

@main("File Upload", user) {
    <div id="file-upload-container">
        <header>
            <h1>File Upload</h1>
            <p>Upload and process files (.rep, .txt, .json, .csv)</p>
        </header>

        <section>
            <div class="grid">
                <div>
                    <article>
                        <header>
                            <h3>Upload File</h3>
                        </header>
                        <form id="upload-form" enctype="multipart/form-data">
                            @helper.CSRF.formField
                            <div id="file-input-container">
                                <input 
                                    class="w-full text-gray-700 px-3 py-2 border rounded" 
                                    id="uploadFileInput" 
                                    type="file" 
                                    name="upload_file"
                                    accept=".rep,.txt,.json,.csv"
                                    style="width: 100%;"
                                />
                                <small>Maximum file size: 1MB. Allowed types: .rep, .txt, .json, .csv</small>
                            </div>
                            
                            <div id="file-info" style="margin-top: 1rem; display: none;">
                                <strong>Selected file:</strong> <span id="selected-filename"></span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <button type="submit" id="upload-button" disabled>Upload File</button>
                                <button type="button" id="clear-button" class="secondary" style="margin-left: 0.5rem;" disabled>Clear</button>
                            </div>
                        </form>
                    </article>
                </div>

                <div>
                    <article id="upload-status">
                        <header>
                            <h3>Upload Status</h3>
                        </header>
                        <div id="status-content">
                            <p>No file selected</p>
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <section>
            <details>
                <summary>Upload Progress</summary>
                <div id="progress-container" style="display: none;">
                    <progress id="upload-progress" value="0" max="100"></progress>
                    <p id="progress-text">0%</p>
                </div>
            </details>
        </section>

        <section id="results-section" style="display: none;">
            <article>
                <header>
                    <h3>Processing Results</h3>
                </header>
                <div id="results-content"></div>
            </article>
        </section>
    </div>

    <style>
        .upload-ready {
            border-left: 4px solid var(--pico-color-blue-500);
            background-color: var(--pico-color-blue-100);
        }
        
        .upload-processing {
            border-left: 4px solid var(--pico-color-orange-500);
            background-color: var(--pico-color-orange-100);
        }
        
        .upload-success {
            border-left: 4px solid var(--pico-color-green-500);
            background-color: var(--pico-color-green-100);
        }
        
        .upload-error {
            border-left: 4px solid var(--pico-color-red-500);
            background-color: var(--pico-color-red-100);
        }
        
        .file-info {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
        }
        
        .file-info strong {
            color: var(--pico-color);
        }
        
        .drag-over {
            border: 2px dashed var(--pico-color-blue-500);
            background-color: var(--pico-color-blue-50);
        }
        
        #upload-progress {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        @@media (prefers-color-scheme: dark) {
            .upload-ready {
                background-color: var(--pico-color-blue-900);
            }
            
            .upload-processing {
                background-color: var(--pico-color-orange-900);
            }
            
            .upload-success {
                background-color: var(--pico-color-green-900);
            }
            
            .upload-error {
                background-color: var(--pico-color-red-900);
            }
            
            .drag-over {
                background-color: var(--pico-color-blue-900);
            }
        }
        
        .w-full {
            width: 100%;
        }
        
        .text-gray-700 {
            color: var(--pico-color-slate-600);
        }
        
        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .border {
            border: 1px solid var(--pico-border-color);
        }
        
        .rounded {
            border-radius: 0.375rem;
        }
    </style>

    <script>
        let selectedFile = null;
        let isUploading = false;

        // DOM elements
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('uploadFileInput');
        const uploadButton = document.getElementById('upload-button');
        const clearButton = document.getElementById('clear-button');
        const fileInfo = document.getElementById('file-info');
        const selectedFilename = document.getElementById('selected-filename');
        const statusContent = document.getElementById('status-content');
        const statusArticle = document.getElementById('upload-status');
        const progressContainer = document.getElementById('progress-container');
        const uploadProgress = document.getElementById('upload-progress');
        const progressText = document.getElementById('progress-text');
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');

        // File input change handler
        fileInput.addEventListener('change', function(event) {
            const files = event.target.files;
            
            if (files.length === 1) {
                handleFileSelection(files[0]);
            } else if (files.length > 1) {
                showError('Please select only one file');
                clearFileSelection();
            } else {
                clearFileSelection();
            }
        });

        // Form submit handler
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (selectedFile && !isUploading) {
                uploadFile();
            }
        });

        // Clear button handler
        clearButton.addEventListener('click', function() {
            clearFileSelection();
        });

        function handleFileSelection(file) {
            selectedFile = file;
            
            // Validate file
            const validation = validateFile(file);
            
            if (validation.valid) {
                showFileInfo(file);
                updateStatus('File selected and ready for upload', 'upload-ready');
                uploadButton.disabled = false;
                clearButton.disabled = false;
            } else {
                showError(validation.error);
                clearFileSelection();
            }
        }

        function validateFile(file) {
            // Check file size (1MB limit)
            const maxSize = 1 * 1024 * 1024;
            if (file.size > maxSize) {
                return { valid: false, error: 'File size must be less than 1MB' };
            }

            // Check file type
            const allowedExtensions = ['.rep', '.txt', '.json', '.csv'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                return { valid: false, error: 'File type not supported. Allowed types: .rep, .txt, .json, .csv' };
            }

            return { valid: true };
        }

        function showFileInfo(file) {
            selectedFilename.textContent = file.name;
            fileInfo.style.display = 'block';
        }

        function clearFileSelection() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadButton.disabled = true;
            clearButton.disabled = true;
            updateStatus('No file selected', '');
            hideProgress();
            hideResults();
        }

        function updateStatus(message, className) {
            statusContent.textContent = message;
            statusArticle.className = className;
        }

        function showError(message) {
            updateStatus(`Error: ${message}`, 'upload-error');
        }

        function showProgress() {
            progressContainer.style.display = 'block';
            uploadProgress.value = 0;
            progressText.textContent = '0%';
        }

        function updateProgress(percent) {
            uploadProgress.value = percent;
            progressText.textContent = `${percent}%`;
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        function showResults(data) {
            resultsContent.innerHTML = `
                <div class="file-info">
                    <span>Filename:</span>
                    <strong>${data.filename}</strong>
                </div>
                <div class="file-info">
                    <span>Size:</span>
                    <strong>${formatFileSize(data.size)}</strong>
                </div>
                <div class="file-info">
                    <span>Content Type:</span>
                    <strong>${data.contentType}</strong>
                </div>
                <div class="file-info">
                    <span>Processed At:</span>
                    <strong>${new Date(data.processedAt).toLocaleString()}</strong>
                </div>
                <div style="margin-top: 1rem;">
                    <small><strong>Base64 Preview:</strong></small>
                    <code style="display: block; word-break: break-all; margin-top: 0.5rem;">${data.base64Preview}...</code>
                </div>
            `;
            resultsSection.style.display = 'block';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uploadFile() {
            if (!selectedFile) return;

            isUploading = true;
            uploadButton.disabled = true;
            clearButton.disabled = true;
            
            updateStatus('Uploading and processing file...', 'upload-processing');
            showProgress();

            const formData = new FormData();
            formData.append('upload_file', selectedFile);

            // Get CSRF token from the form
            const csrfToken = document.querySelector('input[name="csrfToken"]').value;
            formData.append('csrfToken', csrfToken);

            // Simulate progress updates
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;
                updateProgress(Math.round(progress));
            }, 200);

            fetch('@routes.FileUploadController.uploadFile()', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                updateProgress(100);
                
                if (data.status === 'success') {
                    updateStatus('File uploaded and processed successfully!', 'upload-success');
                    showResults(data.data);
                } else {
                    showError(data.message || 'Upload failed');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Upload error:', error);
                showError('Network error during upload');
            })
            .finally(() => {
                isUploading = false;
                uploadButton.disabled = false;
                clearButton.disabled = false;
                
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            });
        }

        // Drag and drop functionality
        const fileInputContainer = document.getElementById('file-input-container');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileInputContainer.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileInputContainer.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileInputContainer.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileInputContainer.classList.add('drag-over');
        }

        function unhighlight(e) {
            fileInputContainer.classList.remove('drag-over');
        }

        fileInputContainer.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length === 1) {
                fileInput.files = files;
                handleFileSelection(files[0]);
            } else if (files.length > 1) {
                showError('Please drop only one file');
            }
        }
    </script>
}
