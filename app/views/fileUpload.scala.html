@import models.User
@import services.{FileProcessResult, MultiFileUploadResult}
@import models.StarCraftModels._
@(user: Option[User], resultOption: Option[MultiFileUploadResult]=None, errorMessage: Option[String] = None)(implicit request: RequestHeader, flash: Flash)

@main("File Upload", user) {
<div id="file-upload-container">
    <header>
        <h1>File Upload</h1>
        <p>Upload and analyze files automatically (.rep)</p>
    </header>

    <section>
        <div class="grid">
            <div>
                <article>
                    <header>
                        <h3>Select Files for Analysis</h3>
                    </header>
                    <form id="upload-form" enctype="multipart/form-data" method="post" action="/upload">
                        @helper.CSRF.formField
                        <div id="file-input-container">
                            <input
                                    id="uploadFileInput"
                                    type="file"
                                    name="upload_file"
                                    accept=".rep"
                                    multiple
                            />
                            <small>Archivos .rep de m√°ximo 1MB cada uno</small>
                        </div>

                        <div id="file-info">
                            <strong>Selected files:</strong> <span id="selected-files-count">0</span> file(s)
                        </div>

                        <div id="validation-errors">
                            <h4>Validation Problems:</h4>
                            <table id="error-table">
                                <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Problem</th>
                                </tr>
                                </thead>
                                <tbody id="error-table-body">
                                </tbody>
                            </table>
                        </div>

                        <button type="submit" id="submit-btn" disabled>
                            Upload Files
                        </button>
                    </form>
                </article>
            </div>
        </div>
    </section>
</div>
@resultOption.map{result =>
<div id="file-upload-results-container">
    <header>
        <h1>File Upload Results</h1>
        <p>Processing completed for @result.totalFiles file(s)</p>
    </header>

    @if(errorMessage.isDefined) {
    <section>
        <article>
            <h3>Upload Error</h3>
            <p>@errorMessage.get</p>
            <a href="/upload" role="button" class="secondary">Try Again</a>
        </article>
    </section>
    } else {
    <!-- Summary Section -->
    <section>
        <div class="grid">
            <div>
                <article>
                    <header>
                        <h3>Upload Summary</h3>
                    </header>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <strong>Total Files:</strong> @result.totalFiles
                        </div>
                        <div class="stat-item">
                            <strong>Successful:</strong> @result.totalSuccessful
                        </div>
                        @if(result.totalFailed > 0) {
                        <div class="stat-item">
                            <strong>Failed:</strong> @result.totalFailed
                        </div>
                        }
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- Successful Files Section -->
    @if(result.successfulFiles.nonEmpty) {
    <section>
        <article>
            <header>
                <h3>Successfully Processed Files (@result.totalSuccessful)</h3>
            </header>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>Map</th>
                        <th>Jugador 1</th>
                        <th>Jugador 2</th>
                        <th>Hora inicio</th>
                    </tr>
                    </thead>
                    <tbody>
                    @for(file <- result.successfulFiles) {
                    <tr>
                        @file.gameInfo match {
                        case Some(replayParsed: ReplayParsed) => {
                        <td>@replayParsed.mapName.getOrElse("Unknown")</td>
                        <td>
                            @if(replayParsed.teams.nonEmpty && replayParsed.teams.head.participants.nonEmpty) {
                            @defining(replayParsed.teams.head.participants.head) { player =>
                            @player.name (@{
                            player.race match {
                            case Zerg => "Z"
                            case Terran => "T"
                            case Protoss => "P"
                            }
                            })
                            }
                            } else {
                            Unknown Player
                            }
                        </td>
                        <td>
                            @if(replayParsed.teams.length > 1 && replayParsed.teams(1).participants.nonEmpty) {
                            @defining(replayParsed.teams(1).participants.head) { player =>
                            @player.name (@{
                            player.race match {
                            case Zerg => "Z"
                            case Terran => "T"
                            case Protoss => "P"
                            }
                            })
                            }
                            } else {
                            Unknown Player
                            }
                        </td>
                        <td>
                            @replayParsed.startTime.getOrElse("Unknown")
                        </td>
                        }
                        case Some(ImpossibleToParse) | None => {
                        <td>?</td>
                        <td>?</td>
                        <td>?</td>
                        <td>?</td>
                        }
                        }
                    </tr>
                    }
                    </tbody>
                </table>
            </div>
        </article>
    </section>
    }

    <!-- Failed Files Section -->
    @if(result.failedFiles.nonEmpty) {
    <section>
        <article>
            <header>
                <h3>Failed Files (@result.totalFailed)</h3>
            </header>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Error</th>
                        <th>Attempted At</th>
                    </tr>
                    </thead>
                    <tbody>
                    @for(file <- result.failedFiles) {
                    <tr>
                        <td>
                            <strong>@file.fileName</strong>
                        </td>
                        <td>
                            @{
                            val sizeInKB = file.originalSize / 1024.0
                            if (sizeInKB < 1024) f"${sizeInKB}%.1f KB"
                            else f"${sizeInKB / 1024}%.2f MB"
                            }
                        </td>
                        <td>
                            @file.errorMessage.getOrElse("Unknown error")
                        </td>
                        <td>
                            @{
                            java.time.Instant.parse(file.processedAt).toString.replace('T', ' ').substring(0, 19)
                            }
                        </td>
                    </tr>
                    }
                    </tbody>
                </table>
            </div>
        </article>
    </section>
    }

    <!-- Action Buttons -->
    <section>
        <div class="grid">
            <div>
                <a href="/upload" role="button" class="secondary">Upload More Files</a>
            </div>
            @if(result.totalSuccessful > 0) {
            <div>
                <button onclick="downloadResults()" class="outline">Download Results Summary</button>
            </div>
            }
        </div>
    </section>
    }
</div>
}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadFileInput = document.getElementById('uploadFileInput');
        const uploadForm = document.getElementById('upload-form');
        const fileInfo = document.getElementById('file-info');
        const selectedFilesCount = document.getElementById('selected-files-count');
        const validationErrors = document.getElementById('validation-errors');
        const errorTableBody = document.getElementById('error-table-body');
        const submitBtn = document.getElementById('submit-btn');

        let validationResults = [];

        uploadFileInput.addEventListener('change', function(event) {
            const files = event.target.files;

            if (files.length === 0) {
                fileInfo.style.display = 'none';
                validationErrors.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }

            // Show file info
            fileInfo.style.display = 'block';
            selectedFilesCount.textContent = files.length;

            // Validate files
            validationResults = validateFiles(files);

            // Check if all files are valid
            const hasErrors = validationResults.some(result => result.errors.length > 0);

            if (hasErrors) {
                showValidationErrors(validationResults);
                submitBtn.disabled = true;
            } else {
                validationErrors.style.display = 'none';
                submitBtn.disabled = false;
                // Auto-submit when all files are valid
                uploadForm.submit();
            }
        });

        uploadForm.addEventListener('submit', function(event) {
            const files = uploadFileInput.files;
            if (files.length === 0) {
                event.preventDefault();
                alert('Please select at least one file');
                return;
            }

            // Re-validate before submission
            validationResults = validateFiles(files);
            const hasErrors = validationResults.some(result => result.errors.length > 0);

            if (hasErrors) {
                event.preventDefault();
                showValidationErrors(validationResults);
                return;
            }

            // If all files are valid, allow normal form submission
            // No need to prevent default - let the form submit naturally
        });

        function validateFiles(files) {
            const results = [];
            const maxSizeBytes = 1 * 1024 * 1024; // 1MB

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const errors = [];

                // Check file extension
                if (!file.name.toLowerCase().endsWith('.rep')) {
                    errors.push('File must have .rep extension');
                }

                // Check file size
                if (file.size > maxSizeBytes) {
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                    errors.push(`File size (${sizeInMB}MB) exceeds 1MB limit`);
                }

                results.push({
                    fileName: file.name,
                    errors: errors
                });
            }

            return results;
        }

        function showValidationErrors(results) {
            const errorsExist = results.some(result => result.errors.length > 0);

            if (!errorsExist) {
                validationErrors.style.display = 'none';
                return;
            }

            // Clear previous errors
            errorTableBody.innerHTML = '';

            // Add errors to table
            results.forEach(result => {
                if (result.errors.length > 0) {
                    result.errors.forEach(error => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td >${escapeHtml(result.fileName)}</td>
                            <td >${escapeHtml(error)}</td>
                        `;
                        errorTableBody.appendChild(row);
                    });
                }
            });

            validationErrors.style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

    });
</script>
}
