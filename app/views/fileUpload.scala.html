@import models.User
@(user: Option[User])(implicit request: RequestHeader, flash: Flash)

@main("File Upload", user) {
    <div id="file-upload-container">
        <header>
            <h1>File Upload</h1>
            <p>Upload and analyze files automatically (.rep)</p>
        </header>

        <section>
            <div class="grid">
                <div>
                    <article>
                        <header>
                            <h3>Select Files for Analysis</h3>
                        </header>
                        <form id="upload-form" enctype="multipart/form-data" method="post" action="/upload">
                            @helper.CSRF.formField
                            <div id="file-input-container">
                                <input 
                                    id="uploadFileInput"
                                    type="file" 
                                    name="upload_file"
                                    accept=".rep"
                                    multiple
                                />
                                <small>Archivos .rep de m√°ximo 1MB cada uno</small>
                            </div>
                            
                            <div id="file-info" style="margin-top: 1rem; display: none;">
                                <strong>Selected files:</strong> <span id="selected-files-count">0</span> file(s)
                            </div>

                            <div id="validation-errors" style="margin-top: 1rem; display: none;">
                                <h4>Validation Problems:</h4>
                                <table id="error-table" style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">File Name</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Problem</th>
                                        </tr>
                                    </thead>
                                    <tbody id="error-table-body">
                                    </tbody>
                                </table>
                            </div>
                            
                            <button type="submit" id="submit-btn" style="margin-top: 1rem;" disabled>
                                Upload Files
                            </button>
                        </form>
                    </article>
                </div>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadFileInput = document.getElementById('uploadFileInput');
            const uploadForm = document.getElementById('upload-form');
            const fileInfo = document.getElementById('file-info');
            const selectedFilesCount = document.getElementById('selected-files-count');
            const validationErrors = document.getElementById('validation-errors');
            const errorTableBody = document.getElementById('error-table-body');
            const submitBtn = document.getElementById('submit-btn');
            
            let validationResults = [];
            
            uploadFileInput.addEventListener('change', function(event) {
                const files = event.target.files;
                
                if (files.length === 0) {
                    fileInfo.style.display = 'none';
                    validationErrors.style.display = 'none';
                    submitBtn.disabled = true;
                    return;
                }
                
                // Show file info
                fileInfo.style.display = 'block';
                selectedFilesCount.textContent = files.length;
                
                // Validate files
                validationResults = validateFiles(files);
                
                // Check if all files are valid
                const hasErrors = validationResults.some(result => result.errors.length > 0);
                
                if (hasErrors) {
                    showValidationErrors(validationResults);
                    submitBtn.disabled = true;
                } else {
                    validationErrors.style.display = 'none';
                    submitBtn.disabled = false;
                    // Auto-submit when all files are valid
                    uploadForm.submit();
                }
            });
            
            uploadForm.addEventListener('submit', function(event) {
                const files = uploadFileInput.files;
                if (files.length === 0) {
                    event.preventDefault();
                    alert('Please select at least one file');
                    return;
                }
                
                // Re-validate before submission
                validationResults = validateFiles(files);
                const hasErrors = validationResults.some(result => result.errors.length > 0);
                
                if (hasErrors) {
                    event.preventDefault();
                    showValidationErrors(validationResults);
                    return;
                }
                
                // If all files are valid, allow normal form submission
                // No need to prevent default - let the form submit naturally
            });
            
            function validateFiles(files) {
                const results = [];
                const maxSizeBytes = 1 * 1024 * 1024; // 1MB
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const errors = [];
                    
                    // Check file extension
                    if (!file.name.toLowerCase().endsWith('.rep')) {
                        errors.push('File must have .rep extension');
                    }
                    
                    // Check file size
                    if (file.size > maxSizeBytes) {
                        const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                        errors.push(`File size (${sizeInMB}MB) exceeds 1MB limit`);
                    }
                    
                    results.push({
                        fileName: file.name,
                        errors: errors
                    });
                }
                
                return results;
            }
            
            function showValidationErrors(results) {
                const errorsExist = results.some(result => result.errors.length > 0);
                
                if (!errorsExist) {
                    validationErrors.style.display = 'none';
                    return;
                }
                
                // Clear previous errors
                errorTableBody.innerHTML = '';
                
                // Add errors to table
                results.forEach(result => {
                    if (result.errors.length > 0) {
                        result.errors.forEach(error => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(result.fileName)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; color: #d32f2f;">${escapeHtml(error)}</td>
                            `;
                            errorTableBody.appendChild(row);
                        });
                    }
                });
                
                validationErrors.style.display = 'block';
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

        });
    </script>
}
