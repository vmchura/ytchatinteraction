@import models.User
@import services.{FileProcessResult, MultiFileUploadResult}
@import models.StarCraftModels._
@import services.UploadSession
@import models.{Tournament, TournamentMatch}
@(user: User, matchID: String, uploadSession: UploadSession, errorMessage: Option[String] = None, tournament: Option[Tournament] = None, tournamentMatch: Option[TournamentMatch] = None, firstUser: Option[User] = None, secondUser: Option[User] = None)(implicit request: RequestHeader, flash: Flash)

@main("File Upload", Some(user)) {
<div id="file-upload-container">
    <header>
        <h1>File Upload</h1>
        @if(tournament.isDefined && tournamentMatch.isDefined && firstUser.isDefined && secondUser.isDefined) {
            <div class="match-info">
                <h2>@tournament.get.name</h2>
                <p class="match-details">
                    <strong>Match:</strong> @firstUser.get.userName vs @secondUser.get.userName
                </p>
                <div class="match-metadata" style="display: none;">
                    <span id="tournament-id">@tournament.get.id</span>
                    <span id="match-id">@tournamentMatch.get.matchId</span>
                </div>
            </div>
        }
        <p>Upload and analyze files automatically (.rep)</p>
    </header>

    @if(uploadSession.hasFiles) {
    <!-- Status Section -->
    <section>
        <article>
            <header>
                <h3>Session Status</h3>
            </header>
            <p>Processing completed for @uploadSession.totalFiles file(s)</p>

            @if(uploadSession.successfulFiles.nonEmpty) {
            <details open>
                <summary>Successfully Processed Files (@uploadSession.successfulFiles.length)</summary>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>Map</th>
                            <th>Jugador 1</th>
                            <th>Jugador 2</th>
                            <th>Hora inicio</th>
                        </tr>
                        </thead>
                        <tbody>
                        @for(file <- uploadSession.successfulFiles) {
                        <tr>
                            @file.gameInfo match {
                            case Some(replayParsed: ReplayParsed) => {
                            <td>@replayParsed.mapName.getOrElse("Unknown")</td>
                            <td>
                                @if(replayParsed.teams.nonEmpty && replayParsed.teams.head.participants.nonEmpty) {
                                @defining(replayParsed.teams.head.participants.head) { player =>
                                @player.name (@{
                                player.race match {
                                case Zerg => "Z"
                                case Terran => "T"
                                case Protoss => "P"
                                }
                                })
                                }
                                } else {
                                Unknown Player
                                }
                            </td>
                            <td>
                                @if(replayParsed.teams.length > 1 && replayParsed.teams(1).participants.nonEmpty) {
                                @defining(replayParsed.teams(1).participants.head) { player =>
                                @player.name (@{
                                player.race match {
                                case Zerg => "Z"
                                case Terran => "T"
                                case Protoss => "P"
                                }
                                })
                                }
                                } else {
                                Unknown Player
                                }
                            </td>
                            <td>
                                @replayParsed.startTime.getOrElse("Unknown")
                            </td>
                            }
                            case Some(ImpossibleToParse) | None => {
                            <td>?</td>
                            <td>?</td>
                            <td>?</td>
                            <td>?</td>
                            }
                            }
                        </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </details>
            }

            @if(uploadSession.failedFiles.nonEmpty) {
            <details open>
                <summary>Failed Files (@uploadSession.failedFiles.length)</summary>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Error</th>
                        </tr>
                        </thead>
                        <tbody>
                        @for(file <- uploadSession.failedFiles) {
                        <tr>
                            <td>@file.fileName</td>
                            <td>@file.errorMessage.getOrElse("Unknown error")</td>
                        </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </details>
            }
        </article>
    </section>
    }

    <!-- Upload Form Section -->
    <section>
        <article>
            <header>
                <h3>@if(uploadSession.hasFiles) {Add More Files} else {Select Files for Analysis}</h3>
            </header>

            <div id="validation-flash" style="display: none;">
                <h4>Validation Problems:</h4>
                <div id="validation-messages"></div>
            </div>

            <form id="upload-form" enctype="multipart/form-data" method="post" action=@{s"/match/$matchID/upload"}>
                @helper.CSRF.formField
                <div id="file-input-container">
                    <input
                            id="uploadFileInput"
                            type="file"
                            name="upload_file"
                            accept=".rep"
                            multiple
                    />
                    <small>Archivos .rep de m√°ximo 1MB cada uno</small>
                </div>

                <div id="file-info" style="display: none;">
                    <strong>Selected files:</strong> <span id="selected-files-count">0</span> file(s)
                </div>

                <button type="submit" id="submit-btn" style="display: none;">
                    Upload Files
                </button>
            </form>
        </article>
    </section>

    @if(errorMessage.isDefined) {
    <section>
        <article>
            <h3>Upload Error</h3>
            <p>@errorMessage.get</p>
            <a href="/upload" role="button" class="secondary">Try Again</a>
        </article>
    </section>
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadFileInput = document.getElementById('uploadFileInput');
        const uploadForm = document.getElementById('upload-form');
        const fileInfo = document.getElementById('file-info');
        const selectedFilesCount = document.getElementById('selected-files-count');
        const validationFlash = document.getElementById('validation-flash');
        const validationMessages = document.getElementById('validation-messages');
        const submitBtn = document.getElementById('submit-btn');

        let validationResults = [];

        uploadFileInput.addEventListener('change', function(event) {
            const files = event.target.files;

            if (files.length === 0) {
                fileInfo.style.display = 'none';
                validationFlash.style.display = 'none';
                return;
            }

            // Show file info
            fileInfo.style.display = 'block';
            selectedFilesCount.textContent = files.length;

            // Validate files
            validationResults = validateFiles(files);

            // Check if all files are valid
            const hasErrors = validationResults.some(result => result.errors.length > 0);

            if (hasErrors) {
                showValidationErrors(validationResults);
            } else {
                validationFlash.style.display = 'none';
                // Auto-submit when all files are valid
                uploadForm.submit();
            }
        });

        function validateFiles(files) {
            const results = [];
            const maxSizeBytes = 1 * 1024 * 1024; // 1MB

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const errors = [];

                // Check file extension
                if (!file.name.toLowerCase().endsWith('.rep')) {
                    errors.push('File must have .rep extension');
                }

                // Check file size
                if (file.size > maxSizeBytes) {
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                    errors.push(`File size (${sizeInMB}MB) exceeds 1MB limit`);
                }

                results.push({
                    fileName: file.name,
                    errors: errors
                });
            }

            return results;
        }

        function showValidationErrors(results) {
            const errorsExist = results.some(result => result.errors.length > 0);

            if (!errorsExist) {
                validationFlash.style.display = 'none';
                return;
            }

            // Clear previous messages
            validationMessages.innerHTML = '';

            // Create flash messages for each file with errors
            results.forEach(result => {
                if (result.errors.length > 0) {
                    result.errors.forEach(error => {
                        const flashCard = document.createElement('div');
                        flashCard.innerHTML = `
                            <strong>${escapeHtml(result.fileName)}:</strong> ${escapeHtml(error)}
                        `;
                        validationMessages.appendChild(flashCard);
                    });
                }
            });

            validationFlash.style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    });
</script>
}