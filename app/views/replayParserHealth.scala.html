@import models.User
@import controllers.StorageHealthStatus
@(user: Option[User], storageHealth: Option[StorageHealthStatus] = None)(implicit flash: Flash)

@main("System Health", user) {
    <div id="health-container">
        <header>
            <h1>System Health Monitoring</h1>
            <p>Monitor the status of the StarCraft replay parsing service and file storage system</p>
        </header>

        <section>
            <div class="grid">
                <div>
                    <article id="health-status" class="loading">
                        <header>
                            <h3>Replay Parser Service</h3>
                        </header>
                        <div id="status-content">
                            <div aria-busy="true">Loading service status...</div>
                        </div>
                    </article>
                </div>
                
                <div>
                    <article id="storage-status" class="@{storageHealth.map(h => s"status-${h.status}").getOrElse("loading")}">
                        <header>
                            <h3>File Storage</h3>
                        </header>
                        <div id="storage-content">
                            @storageHealth match {
                                case Some(storage) => {
                                    <div class="metric">
                                        <span><span class="status-indicator @{storage.status}"></span>Status:</span>
                                        <strong>@{storage.status.capitalize}</strong>
                                    </div>
                                    <div class="metric">
                                        <span>Path:</span>
                                        <code>@storage.path</code>
                                    </div>
                                    <div class="metric">
                                        <span>Accessible:</span>
                                        <strong>@{if(storage.exists && storage.readable && storage.writable) "Yes" else "No"}</strong>
                                    </div>
                                    @storage.fileCount.map { count =>
                                        <div class="metric">
                                            <span>Files:</span>
                                            <strong>@count</strong>
                                        </div>
                                    }
                                    @storage.freeSpaceGB.map { free =>
                                        <div class="metric">
                                            <span>Free Space:</span>
                                            <strong>@{free}GB</strong>
                                        </div>
                                    }
                                    @storage.error.map { error =>
                                        <div class="metric">
                                            <span>Error:</span>
                                            <strong style="color: var(--pico-color-red-500);">@error</strong>
                                        </div>
                                    }
                                    <div class="metric">
                                        <span>Last Check:</span>
                                        <strong>@{java.time.Instant.parse(storage.checkedAt).toString}</strong>
                                    </div>
                                }
                                case None => {
                                    <div aria-busy="true">Loading storage status...</div>
                                }
                            }
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <section>
            <div class="grid">
                <div>
                    <article id="service-info">
                        <header>
                            <h3>Service Information</h3>
                        </header>
                        <div id="info-content">
                            <div aria-busy="true">Loading service info...</div>
                        </div>
                    </article>
                </div>
                
                <div>
                    <article>
                        <header>
                            <h3>Storage Operations</h3>
                        </header>
                        <div class="grid">
                            <button id="test-storage" class="secondary">Test Storage Write</button>
                            <button id="list-files" class="outline">List Files</button>
                        </div>
                        <div id="storage-test-result" style="margin-top: 1rem;"></div>
                    </article>
                </div>
            </div>
        </section>

        <section>
            <details>
                <summary>Manual Actions</summary>
                <div class="grid">
                    <button id="refresh-health" class="secondary">Refresh All Health Checks</button>
                    <button id="test-parse" class="outline">Test Parser Endpoint</button>
                    <button id="full-health-check" class="primary">Full System Check</button>
                </div>
            </details>
        </section>

        <section>
            <details>
                <summary>API Endpoints</summary>
                <table>
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Method</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th colspan="3">Replay Parser Service</th>
                        </tr>
                        <tr>
                            <td><code>/api/replay-parser/health</code></td>
                            <td>GET</td>
                            <td>Parser service health check</td>
                        </tr>
                        <tr>
                            <td><code>/api/replay-parser/status</code></td>
                            <td>GET</td>
                            <td>Detailed parser service status</td>
                        </tr>
                        <tr>
                            <td><code>/api/replay-parser/test</code></td>
                            <td>POST</td>
                            <td>Test parser endpoint connectivity</td>
                        </tr>
                        <tr>
                            <th colspan="3">Storage System</th>
                        </tr>
                        <tr>
                            <td><code>/api/storage/health</code></td>
                            <td>GET</td>
                            <td>Storage system health check</td>
                        </tr>
                        <tr>
                            <td><code>/api/storage/test-write</code></td>
                            <td>POST</td>
                            <td>Test storage write capability</td>
                        </tr>
                        <tr>
                            <td><code>/api/storage/list</code></td>
                            <td>GET</td>
                            <td>List files in storage directory</td>
                        </tr>
                        <tr>
                            <td><code>/api/system/health</code></td>
                            <td>GET</td>
                            <td>Full system health check</td>
                        </tr>
                    </tbody>
                </table>
            </details>
        </section>
    </div>

    <style>
        .status-healthy {
            border-left: 4px solid var(--pico-color-green-500);
            background-color: var(--pico-color-green-100);
        }
        
        .status-unhealthy {
            border-left: 4px solid var(--pico-color-red-500);
            background-color: var(--pico-color-red-100);
        }
        
        .status-unreachable {
            border-left: 4px solid var(--pico-color-orange-500);
            background-color: var(--pico-color-orange-100);
        }
        
        .loading {
            border-left: 4px solid var(--pico-color-blue-500);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.healthy {
            background-color: var(--pico-color-green-500);
        }
        
        .status-indicator.unhealthy {
            background-color: var(--pico-color-red-500);
        }
        
        .status-indicator.unreachable {
            background-color: var(--pico-color-orange-500);
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
        }
        
        .metric strong {
            color: var(--pico-color);
        }
        
        code {
            background-color: var(--pico-color-slate-100);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        @@media (prefers-color-scheme: dark) {
            .status-healthy {
                background-color: var(--pico-color-green-900);
            }
            
            .status-unhealthy {
                background-color: var(--pico-color-red-900);
            }
            
            .status-unreachable {
                background-color: var(--pico-color-orange-900);
            }
            
            code {
                background-color: var(--pico-color-slate-800);
            }
        }
    </style>

    <script>
        let healthInterval;
        
        function updateHealthStatus() {
            fetch('/api/replay-parser/status', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const statusContent = document.getElementById('status-content');
                const statusArticle = document.getElementById('health-status');
                
                statusArticle.classList.remove('loading');
                statusArticle.className = 'status-' + data.status;
                
                const statusIndicator = data.reachable 
                    ? (data.status === 'healthy' ? 'healthy' : 'unhealthy')
                    : 'unreachable';
                
                statusContent.innerHTML = `
                    <div class="metric">
                        <span><span class="status-indicator ${statusIndicator}"></span>Status:</span>
                        <strong>${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</strong>
                    </div>
                    <div class="metric">
                        <span>URL:</span>
                        <code>${data.url}</code>
                    </div>
                    <div class="metric">
                        <span>Response Time:</span>
                        <strong>${data.responseTime}ms</strong>
                    </div>
                    <div class="metric">
                        <span>Last Check:</span>
                        <strong>${new Date(data.timestamp).toLocaleTimeString()}</strong>
                    </div>
                    ${data.error ? `
                        <div class="metric">
                            <span>Error:</span>
                            <strong style="color: var(--pico-color-red-500);">${data.error}</strong>
                        </div>
                    ` : ''}
                `;
                
                const infoContent = document.getElementById('info-content');
                if (data.serviceInfo && Object.keys(data.serviceInfo).length > 0) {
                    const serviceInfo = data.serviceInfo;
                    infoContent.innerHTML = `
                        <div class="metric">
                            <span>Service:</span>
                            <strong>${serviceInfo.service || 'Unknown'}</strong>
                        </div>
                        <div class="metric">
                            <span>Version:</span>
                            <strong>${serviceInfo.version || 'Unknown'}</strong>
                        </div>
                        ${serviceInfo.endpoints ? `
                            <div style="margin-top: 1rem;">
                                <small><strong>Available Endpoints:</strong></small>
                                <ul>
                                    ${Object.entries(serviceInfo.endpoints).map(([key, value]) => 
                                        `<li><code>${key}</code>: ${value}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;
                } else {
                    infoContent.innerHTML = '<p>Service information not available</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching health status:', error);
                const statusContent = document.getElementById('status-content');
                const statusArticle = document.getElementById('health-status');
                
                statusArticle.className = 'status-unreachable';
                statusContent.innerHTML = `
                    <div class="metric">
                        <span><span class="status-indicator unreachable"></span>Status:</span>
                        <strong>Connection Error</strong>
                    </div>
                    <div class="metric">
                        <span>Error:</span>
                        <strong style="color: var(--pico-color-red-500);">${error.message}</strong>
                    </div>
                `;
            });
        }

        function updateStorageStatus() {
            fetch('/api/storage/health', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const storageContent = document.getElementById('storage-content');
                const storageArticle = document.getElementById('storage-status');
                
                storageArticle.classList.remove('loading');
                storageArticle.className = 'status-' + data.status;
                
                const statusIndicator = data.status === 'healthy' ? 'healthy' : 
                                      data.status === 'unhealthy' ? 'unhealthy' : 'unreachable';
                
                storageContent.innerHTML = `
                    <div class="metric">
                        <span><span class="status-indicator ${statusIndicator}"></span>Status:</span>
                        <strong>${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</strong>
                    </div>
                    <div class="metric">
                        <span>Path:</span>
                        <code>${data.path}</code>
                    </div>
                    <div class="metric">
                        <span>Accessible:</span>
                        <strong>${data.exists && data.readable && data.writable ? 'Yes' : 'No'}</strong>
                    </div>
                    ${data.fileCount !== null ? `
                        <div class="metric">
                            <span>Files:</span>
                            <strong>${data.fileCount}</strong>
                        </div>
                    ` : ''}
                    ${data.freeSpaceGB !== null ? `
                        <div class="metric">
                            <span>Free Space:</span>
                            <strong>${data.freeSpaceGB}GB</strong>
                        </div>
                    ` : ''}
                    ${data.error ? `
                        <div class="metric">
                            <span>Error:</span>
                            <strong style="color: var(--pico-color-red-500);">${data.error}</strong>
                        </div>
                    ` : ''}
                    <div class="metric">
                        <span>Last Check:</span>
                        <strong>${new Date(data.checkedAt).toLocaleTimeString()}</strong>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error fetching storage status:', error);
                const storageContent = document.getElementById('storage-content');
                const storageArticle = document.getElementById('storage-status');
                
                storageArticle.className = 'status-unreachable';
                storageContent.innerHTML = `
                    <div class="metric">
                        <span><span class="status-indicator unreachable"></span>Status:</span>
                        <strong>Connection Error</strong>
                    </div>
                    <div class="metric">
                        <span>Error:</span>
                        <strong style="color: var(--pico-color-red-500);">${error.message}</strong>
                    </div>
                `;
            });
        }
        
        function startHealthMonitoring() {
            updateHealthStatus();
            updateStorageStatus();
            healthInterval = setInterval(() => {
                updateHealthStatus();
                updateStorageStatus();
            }, 30000);
        }
        
        function stopHealthMonitoring() {
            if (healthInterval) {
                clearInterval(healthInterval);
            }
        }

        function testStorageWrite() {
            const resultDiv = document.getElementById('storage-test-result');
            resultDiv.innerHTML = '<div aria-busy="true">Testing storage write...</div>';
            
            fetch('/api/storage/test-write', {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const isSuccess = data.status === 'success';
                resultDiv.innerHTML = `
                    <div class="metric">
                        <span>Test Result:</span>
                        <strong style="color: ${isSuccess ? 'var(--pico-color-green-500)' : 'var(--pico-color-red-500)'}">
                            ${data.status.toUpperCase()}
                        </strong>
                    </div>
                    <div class="metric">
                        <span>Message:</span>
                        <span>${data.message}</span>
                    </div>
                `;
                updateStorageStatus();
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="metric">
                        <span>Test Result:</span>
                        <strong style="color: var(--pico-color-red-500)">ERROR</strong>
                    </div>
                    <div class="metric">
                        <span>Error:</span>
                        <span>${error.message}</span>
                    </div>
                `;
            });
        }

        function listStorageFiles() {
            const resultDiv = document.getElementById('storage-test-result');
            resultDiv.innerHTML = '<div aria-busy="true">Loading file list...</div>';
            
            fetch('/api/storage/list', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    resultDiv.innerHTML = `
                        <div class="metric">
                            <span>File Count:</span>
                            <strong>${data.fileCount}</strong>
                        </div>
                        ${data.files.length > 0 ? `
                            <details style="margin-top: 0.5rem;">
                                <summary>Files in Storage</summary>
                                <ul style="max-height: 200px; overflow-y: auto;">
                                    ${data.files.map(file => 
                                        `<li><code>${file.name}</code> (${(file.size / 1024).toFixed(1)}KB, ${new Date(file.lastModified).toLocaleDateString()})</li>`
                                    ).join('')}
                                </ul>
                            </details>
                        ` : '<p>No files found in storage directory.</p>'}
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="metric">
                            <span>Status:</span>
                            <strong style="color: var(--pico-color-red-500)">${data.status.toUpperCase()}</strong>
                        </div>
                        ${data.message ? `
                            <div class="metric">
                                <span>Message:</span>
                                <span>${data.message}</span>
                            </div>
                        ` : ''}
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="metric">
                        <span>Error:</span>
                        <strong style="color: var(--pico-color-red-500)">${error.message}</strong>
                    </div>
                `;
            });
        }

        function runFullHealthCheck() {
            fetch('/api/system/health', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                alert(`System Health: ${data.overall.toUpperCase()}\n\nParser: ${data.parser.status}\nStorage: ${data.storage.status}\n\nLast checked: ${new Date(data.checkedAt).toLocaleString()}`);
                updateHealthStatus();
                updateStorageStatus();
            })
            .catch(error => {
                alert(`Failed to perform full health check: ${error.message}`);
            });
        }
        
        // Event listeners
        document.getElementById('refresh-health').addEventListener('click', () => {
            updateHealthStatus();
            updateStorageStatus();
        });
        
        document.getElementById('test-parse').addEventListener('click', function() {
            fetch('/api/replay-parser/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test: true })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Parse Test Result: ${data.status}\n${data.message}`);
            })
            .catch(error => {
                alert(`Parse endpoint is unreachable: ${error.message}`);
            });
        });

        document.getElementById('test-storage').addEventListener('click', testStorageWrite);
        document.getElementById('list-files').addEventListener('click', listStorageFiles);
        document.getElementById('full-health-check').addEventListener('click', runFullHealthCheck);
        
        document.addEventListener('DOMContentLoaded', startHealthMonitoring);
        window.addEventListener('beforeunload', stopHealthMonitoring);
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopHealthMonitoring();
            } else {
                startHealthMonitoring();
            }
        });
    </script>
}